From 37fa9e143be8cedfb2dcc8c37f94739e7bab1d1d Mon Sep 17 00:00:00 2001
From: Roman Stratiienko <r.stratiienko@gmail.com>
Date: Fri, 7 Apr 2023 00:17:22 +0300
Subject: [PATCH 7/7] Fixes for OTA updates

Followed by [1]:

https://source.android.com/docs/core/ota/virtual_ab/implement
Signed-off-by: Roman Stratiienko <r.stratiienko@gmail.com>
---
 common/base/board.mk                 | 2 +-
 common/base/device.mk                | 2 ++
 platform/kernel/android-extra.config | 3 +++
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/common/base/board.mk b/common/base/board.mk
index 364e003..b73abe5 100644
--- a/common/base/board.mk
+++ b/common/base/board.mk
@@ -109,7 +109,7 @@ BOARD_GLODROID_DYNAMIC_PARTITIONS_SIZE := $(shell echo $$(( $(BOARD_SUPER_PARTIT
 BOARD_GLODROID_DYNAMIC_PARTITIONS_PARTITION_LIST := system system_ext vendor product vendor_dlkm
 
 AB_OTA_UPDATER := true
-AB_OTA_PARTITIONS += boot system system_ext vendor product vendor_dlkm vendor_boot vbmeta vbmeta_system
+AB_OTA_PARTITIONS += boot system system_ext vendor product vendor_dlkm vendor_boot vbmeta vbmeta_system dtbo
 
 TARGET_RECOVERY_PIXEL_FORMAT := RGBX_8888
 
diff --git a/common/base/device.mk b/common/base/device.mk
index e93702b..d0210bf 100644
--- a/common/base/device.mk
+++ b/common/base/device.mk
@@ -25,6 +25,8 @@ $(call inherit-product, $(SRC_TARGET_DIR)/product/userspace_reboot.mk)
 $(call inherit-product, $(SRC_TARGET_DIR)/product/virtual_ab_ota/android_t_baseline.mk)
 PRODUCT_VIRTUAL_AB_COMPRESSION_METHOD := gz
 
+$(call inherit-product, $(SRC_TARGET_DIR)/product/generic_ramdisk.mk)
+
 # Installs gsi keys into ramdisk, to boot a developer GSI with verified boot.
 $(call inherit-product, $(SRC_TARGET_DIR)/product/developer_gsi_keys.mk)
 
diff --git a/platform/kernel/android-extra.config b/platform/kernel/android-extra.config
index 639919f..f127417 100644
--- a/platform/kernel/android-extra.config
+++ b/platform/kernel/android-extra.config
@@ -72,3 +72,6 @@ CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
 
 # Override default configuration that may have comporessed modules enabled
 CONFIG_MODULE_COMPRESS_NONE=y
+
+#  Required for compressed virtual AB OTA
+CONFIG_DM_USER=y
-- 
2.37.2

