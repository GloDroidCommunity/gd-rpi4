From c651f734dee220e6a42feb73e3f8275d121a07f8 Mon Sep 17 00:00:00 2001
From: Roman Stratiienko <r.stratiienko@gmail.com>
Date: Sat, 8 Oct 2022 14:20:06 +0300
Subject: [PATCH] RPI4: HW Codecs initial support

Not for public use yet

Signed-off-by: Roman Stratiienko <r.stratiienko@gmail.com>
---
 common/device-common.mk              | 40 +++++++++++++++++++++++++---
 common/manifest.xml                  |  9 +++++++
 common/sepolicy/vendor/file_contexts |  8 ++++++
 rpi4/device.mk                       |  5 ++--
 4 files changed, 57 insertions(+), 5 deletions(-)

diff --git a/common/device-common.mk b/common/device-common.mk
index 1020bac..f1e1465 100644
--- a/common/device-common.mk
+++ b/common/device-common.mk
@@ -120,8 +120,8 @@ PRODUCT_PACKAGES += \
 
 ## Composer HAL for gralloc4 + minigbm gralloc4
 PRODUCT_PACKAGES += \
-    android.hardware.graphics.allocator@4.0-service.minigbm_gbm_mesa \
-    android.hardware.graphics.mapper@4.0-impl.minigbm_gbm_mesa \
+    android.hardware.graphics.allocator@4.0-service.minigbm_dmabuf \
+    android.hardware.graphics.mapper@4.0-impl.minigbm_dmabuf \
     libgbm_mesa_wrapper \
     hwcomposer.drm \
 
@@ -180,6 +180,12 @@ PRODUCT_PACKAGES += Launcher3QuickStep
 PRODUCT_PROPERTY_OVERRIDES += ro.sf.lcd_density=160
 endif
 
+# V4L2 codec2
+PRODUCT_PACKAGES += \
+    android.hardware.media.c2@1.0-service-v4l2 \
+    libv4l2_codec2_vendor_allocator            \
+    libc2plugin_store                          \
+
 #External USB Camera HAL
 PRODUCT_PACKAGES += \
     android.hardware.camera.provider@2.5-external-service \
@@ -228,11 +234,14 @@ PRODUCT_COPY_FILES += \
 
 # Copy media codecs config file
 PRODUCT_COPY_FILES += \
-    frameworks/av/media/libstagefright/data/media_codecs_google_c2.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs.xml \
+    device/glodroid/common/media_codecs.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs.xml \
+    device/glodroid/common/media_codecs_v4l2_c2_video.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs_v4l2_c2_video.xml \
     frameworks/av/media/libstagefright/data/media_codecs_google_c2_video.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs_google_c2_video.xml \
     frameworks/av/media/libstagefright/data/media_codecs_google_c2_audio.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs_google_c2_audio.xml \
     device/glodroid/common/media_profiles_V1_0.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_profiles_V1_0.xml \
 
+#    frameworks/av/media/libstagefright/data/media_codecs_google_c2.xml:$(TARGET_COPY_OUT_VENDOR)/etc/media_codecs.xml \
+
 PRODUCT_COPY_FILES += \
     device/glodroid/common/init.common.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/init.common.rc \
 
@@ -266,9 +275,34 @@ PRODUCT_COPY_FILES += \
 
 # Vendor seccomp policy files:
 PRODUCT_COPY_FILES += \
+    $(LOCAL_PATH)/seccomp_policy/codec2.vendor.ext.policy:$(TARGET_COPY_OUT_VENDOR)/etc/seccomp_policy/codec2.vendor.ext.policy \
     $(LOCAL_PATH)/seccomp_policy/mediaswcodec.policy:$(TARGET_COPY_OUT_VENDOR)/etc/seccomp_policy/mediaswcodec.policy \
     $(LOCAL_PATH)/seccomp_policy/mediacodec.policy:$(TARGET_COPY_OUT_VENDOR)/etc/seccomp_policy/mediacodec.policy \
 
+# Set the customized property of v4l2_codec2, including:
+# - The maximum concurrent instances for decoder/encoder.
+#   It should be the same as "concurrent-instances" at media_codec_c2.xml.
+PRODUCT_PROPERTY_OVERRIDES += \
+    ro.vendor.v4l2_codec2.decode_concurrent_instances=8 \
+    ro.vendor.v4l2_codec2.encode_concurrent_instances=8 \
+
+# Codec2.0 poolMask:
+#   ION(16)
+#   GRALLOC(17)
+#   BUFFERQUEUE(18)
+#   BLOB(19)
+#   V4L2_BUFFERQUEUE(20)
+#   V4L2_BUFFERPOOL(21)
+#   SECURE_LINEAR(22)
+#   SECURE_GRAPHIC(23)
+#
+# For linear buffer allocation:
+#   If ION is chosen, then the mask should be 0xf50000
+#   If GRALLOC is chosen, then the mask should be 0xf60000
+#   If BLOB is chosen, then the mask should be 0xfc0000
+PRODUCT_PROPERTY_OVERRIDES += \
+    debug.stagefright.c2-poolmask=0xf80000 \
+
 # Recovery
 PRODUCT_COPY_FILES += \
     $(LOCAL_PATH)/init.recovery.glodroid.rc:recovery/root/init.recovery.$(TARGET_PRODUCT).rc \
diff --git a/common/manifest.xml b/common/manifest.xml
index 71bec1d..94623fb 100644
--- a/common/manifest.xml
+++ b/common/manifest.xml
@@ -37,4 +37,13 @@
             <instance>legacy/0</instance>
         </interface>
     </hal>
+    <hal format="hidl">
+        <name>android.hardware.media.c2</name>
+        <transport>hwbinder</transport>
+        <version>1.0</version>
+        <interface>
+            <name>IComponentStore</name>
+            <instance>default</instance>
+        </interface>
+    </hal>
 </manifest>
diff --git a/common/sepolicy/vendor/file_contexts b/common/sepolicy/vendor/file_contexts
index 4d4bbf4..0929ba5 100644
--- a/common/sepolicy/vendor/file_contexts
+++ b/common/sepolicy/vendor/file_contexts
@@ -20,9 +20,13 @@
 
 # Minigbm
 /vendor/bin/hw/android\.hardware\.graphics\.allocator@4\.0-service\.minigbm_gbm_mesa     u:object_r:hal_graphics_allocator_default_exec:s0
+/vendor/bin/hw/android\.hardware\.graphics\.allocator@4\.0-service\.minigbm_dmabuf       u:object_r:hal_graphics_allocator_default_exec:s0
 /vendor/lib(64)?/hw/android\.hardware\.graphics\.mapper@4\.0-impl\.minigbm_gbm_mesa\.so  u:object_r:same_process_hal_file:s0
+/vendor/lib(64)?/hw/android\.hardware\.graphics\.mapper@4\.0-impl\.minigbm_dmabuf\.so    u:object_r:same_process_hal_file:s0
 /vendor/lib(64)?/hw/gralloc\.minigbm_gbm_mesa\.so                                        u:object_r:same_process_hal_file:s0
+/vendor/lib(64)?/hw/gralloc\.minigbm_dmabuf\.so                                          u:object_r:same_process_hal_file:s0
 /vendor/lib(64)?/libminigbm_gralloc_gbm_mesa\.so                                         u:object_r:same_process_hal_file:s0
+/vendor/lib(64)?/libminigbm_gralloc_dmabuf\.so                                           u:object_r:same_process_hal_file:s0
 
 /dev/block/zram0                                                                u:object_r:swap_block_device:s0
 
@@ -42,3 +46,7 @@
 /dev/video16                                                                    u:object_r:camera_device:s0
 /dev/media1                                                                     u:object_r:camera_device:s0
 /dev/media2                                                                     u:object_r:camera_device:s0
+
+# V4L2 codec2
+/vendor/bin/hw/android\.hardware\.media\.c2@1\.0-service-v4l2(.*)?              u:object_r:mediacodec_exec:s0
+/vendor/lib(64)?/libc2plugin_store\.so                                          u:object_r:same_process_hal_file:s0
diff --git a/rpi4/device.mk b/rpi4/device.mk
index 628b8d9..e8afbe1 100644
--- a/rpi4/device.mk
+++ b/rpi4/device.mk
@@ -44,8 +44,9 @@ PRODUCT_COPY_FILES += \
     device/glodroid/common/no_suspend.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/no_suspend.rpi4.rc \
 
 PRODUCT_COPY_FILES += \
-    $(LOCAL_PATH)/power.rpi4.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/power.rpi4.rc \
-    $(LOCAL_PATH)/snd.rpi4.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/snd.rpi4.rc     \
+    $(LOCAL_PATH)/hwcodecs.rpi4.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/hwcodecs.rpi4.rc \
+    $(LOCAL_PATH)/power.rpi4.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/power.rpi4.rc       \
+    $(LOCAL_PATH)/snd.rpi4.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/snd.rpi4.rc           \
 
 # Checked by android.opengl.cts.OpenGlEsVersionTest#testOpenGlEsVersion. Required to run correct set of dEQP tests.
 # 196609 == 0x00030001 == GLES v3.1
-- 
2.34.1

